<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ¤ç‰©å¤§æˆ˜åƒµå°¸ - é˜³å…‰ç‰ˆ</title>
    <style>
        body {
            background-color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            margin: 0;
            padding: 20px;
        }
        h1 { margin-bottom: 10px; }
        #game-container {
            display: flex;
            gap: 20px;
        }
        canvas {
            background-color: #87CEEB; /* å¤©ç©ºè“èƒŒæ™¯ */
            border: 4px solid #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #ui-panel {
            width: 200px;
            background: #34495e;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .btn {
            padding: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-sunflower { background-color: #f1c40f; color: #333; }
        .btn-peashooter { background-color: #2ecc71; color: #fff; }
        .btn-wallnut { background-color: #e67e22; color: #fff; }
        .btn-restart { background-color: #e74c3c; color: #fff; margin-top: 10px;}
        
        .stats { font-size: 1.2em; margin-top: 10px; border-top: 1px solid #7f8c8d; padding-top: 10px; }
        .stat-item { display: flex; justify-content: space-between; margin: 5px 0; }
        .selected { border: 3px solid white; }
        
        .info-text { font-size: 0.9em; color: #bdc3c7; text-align: center; }
    </style>
</head>
<body>

    <h1>ğŸŒ» æ¤ç‰©å¤§æˆ˜åƒµå°¸ (é˜³å…‰ç‰ˆ) ğŸ§Ÿ</h1>
    <p class="info-text">æ³¨æ„ï¼šæ¤ç‰©éœ€è¦é˜³å…‰æ‰èƒ½ç”Ÿé•¿ï¼ç•ªèŒ„å¯ä»¥äº§ç”Ÿé˜³å…‰ã€‚</p>
    
    <div id="game-container">
        <!-- æ¸¸æˆç”»å¸ƒ -->
        <canvas id="gameCanvas" width="800" height="400"></canvas>

        <!-- ä¾§è¾¹æ ï¼šå•†åº—å’Œä¿¡æ¯ -->
        <div id="ui-panel">
            <h3>æ¤ç‰©å¡ç‰‡</h3>
            <p><small>æ¤ç‰©éœ€è¦é˜³å…‰æ‰èƒ½ç”Ÿé•¿ã€‚ç§ä¸‹åéœ€è¦ç­‰å¾…é˜³å…‰æˆç†Ÿã€‚</small></p>
            <button class="btn btn-sunflower" onclick="selectPlant('sunflower')">ğŸŒ» ç•ªèŒ„ (250é‡‘å¸ + 50é˜³å…‰)</button>
            <button class="btn btn-peashooter" onclick="selectPlant('peashooter')">ğŸŒ¿è±Œè±†å°„æ‰‹ (100é‡‘å¸ + 20é˜³å…‰)</button>
            <button class="btn btn-wallnut" onclick="selectPlant('wallnut')">ğŸŒ°åšæœå¢™ (50é‡‘å¸ + 100é˜³å…‰)</button>
            
            <div class="stats">
                <div class="stat-item">ğŸª™ é‡‘å¸: <span id="score">500</span></div>
                <div class="stat-item">â˜€ï¸ é˜³å…‰: <span id="sun">100</span></div>
                <div class="stat-item">ğŸ§Ÿ zombieCount: <span id="zombieCount">0</span></div>
            </div>
            <button class="btn btn-restart" onclick="resetGame()">ğŸ”„ é‡ç½®æ¸¸æˆ</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const sunEl = document.getElementById('sun');
        const zombieCountEl = document.getElementById('zombieCount');

        // æ¸¸æˆé…ç½®
        const GRID_SIZE = 50; // æ¯ä¸ªæ ¼å­çš„å¤§å°
        const ROWS = 8;
        const COLS = 12;
        
        // æ¸¸æˆçŠ¶æ€
        let score = 500; // åˆå§‹é‡‘å¸
        let sun = 100;    // é˜³å…‰æ•°é‡
        let sunRate = 0; // é˜³å…‰äº§ç”Ÿé€Ÿåº¦
        let selectedPlantType = null;
        let gameLoopId;
        let lastTime = 0;
        let dropZombieTimer = 0;
        let sunProductionTimer = 0;

        // æ¤ç‰©å’Œåƒµå°¸æ•°ç»„
        let plants = [];
        let zombies = [];
        let bullets = []; // åŒ…æ‹¬å­å¼¹å’Œè±Œè±†æŠ•æ‰‹æ‰”å‡ºçš„è±Œè±†

        // æ¤ç‰©å®šä¹‰
        const PLANTS_DB = {
            sunflower: { 
                cost: 250, 
                sunCost: 50,
                color: '#e67e22', 
                height: 40, 
                shootCooldown: 0,
                growthTime: 6000, // ç”Ÿé•¿éœ€è¦6ç§’
                isProducing: true // æˆç†Ÿåæ˜¯å¦æŒç»­äº§ç”Ÿé˜³å…‰
            },
            peashooter: { 
                cost: 100, 
                sunCost: 20,
                color: '#2ecc71', 
                height: 40, 
                shootCooldown: 2000,
                growthTime: 3000,  // ç”Ÿé•¿éœ€è¦3ç§’
                isProducing: false
            },
            wallnut: { 
                cost: 50, 
                sunCost: 100,
                color: '#e67e22',
                height: 60,
                shootCooldown: 0,
                growthTime: 0,   // åšæœä¸éœ€è¦ç”Ÿé•¿æ—¶é—´
                isProducing: false
            }
        };

        class Plant {
            constructor(col, row, type) {
                this.type = type;
                this.col = col;
                this.row = row;
                this.x = col * GRID_SIZE + 10;
                this.y = row * GRID_SIZE + 50;
                this.width = GRID_SIZE - 20;
                this.height = PLANTS_DB[type].height;
                this.color = PLANTS_DB[type].color;
                
                // ç”Ÿé•¿ç›¸å…³
                this.growthTime = PLANTS_DB[type].growthTime;
                this.elapsedTime = 0;
                this.isGrown = false;
                this.canShoot = false;
                this.lastShot = 0;
                this.isProducing = PLANTS_DB[type].isProducing; // æ˜¯å¦äº§ç”Ÿé˜³å…‰
            }

            draw() {
                // ç»˜åˆ¶ç”Ÿé•¿è¿›åº¦
                if (this.growthTime > 0 && !this.isGrown) {
                    const progress = Math.min(this.elapsedTime / this.growthTime, 1);
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(this.x, this.y - 10, this.width, 10);
                    ctx.fillStyle = '#f39c12';
                    ctx.fillRect(this.x, this.y - 10, this.width * progress, 10);
                    
                    ctx.fillStyle = '#000';
                    ctx.textAlign = 'center';
                    ctx.font = '10px Arial';
                    ctx.fillText(`${Math.floor(progress * 100)}%`, this.x + this.width/2, this.y);
                    return;
                }

                // æˆç†Ÿæ¤ç‰©
                if (this.type === 'sunflower') {
                    // ç”»ä¸€ä¸ªç®€å•çš„ç•ªèŒ„
                    ctx.fillStyle = '#e67e22';
                    ctx.beginPath();
                    ctx.arc(this.x + this.width/2, this.y + this.height - 10, 20, 0, Math.PI * 2);
                    ctx.fill();
                    // ç”»èŒ
                    ctx.strokeStyle = '#27ae60';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.moveTo(this.x + this.width/2, this.y + this.height);
                    ctx.lineTo(this.x + this.width/2, this.y + 40);
                    ctx.stroke();
                    
                    // äº§ç”Ÿé˜³å…‰æ•ˆæœ
                    if (this.isProducing && this.canShoot && Math.random() < 0.05) {
                        sun++;
                        drawSunEffect(this.x + this.width/2, this.y);
                    }
                } else if (this.type === 'peashooter') {
                    // ç”»è±Œè±†å°„æ‰‹
                    ctx.fillStyle = '#2ecc71';
                    ctx.fillRect(this.x + 5, this.y + 5, this.width - 10, this.height - 10);
                    // çœ¼ç›
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(this.x + 10, this.y + 20, 15, 10);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(this.x + 15, this.y + 25, 5, 5);
                } else if (this.type === 'wallnut') {
                    // ç”»åšæœå¢™
                    ctx.fillStyle = '#f1c40f';
                    ctx.beginPath();
                    ctx.arc(this.x + this.width/2, this.y + this.height/2, 30, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#d35400';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    // è£‚çº¹
                    ctx.fillStyle = '#e67e22';
                    ctx.beginPath();
                    ctx.moveTo(this.x + 15, this.y + 50);
                    ctx.lineTo(this.x + 35, this.y + 55);
                    ctx.lineTo(this.x + 15, this.y + 60);
                    ctx.fill();
                }
            }

            update(currentTime) {
                // å¤„ç†ç”Ÿé•¿
                if (!this.isGrown && this.growthTime > 0) {
                    this.elapsedTime += currentTime - (this.lastUpdateTime || currentTime);
                    if (this.elapsedTime >= this.growthTime) {
                        this.isGrown = true;
                        this.canShoot = true;
                    }
                }
                
                this.lastUpdateTime = currentTime;
                
                // æˆç†Ÿåæ‰èƒ½æ”»å‡»
                if (!this.isGrown || !this.canShoot) return;

                if (this.type === 'peashooter') {
                    // æ£€æŸ¥æ˜¯å¦æœ‰åƒµå°¸åœ¨èŒƒå›´å†…
                    const zombieInRange = zombies.find(z => z.x < this.x + this.width && z.x + 40 > this.x);
                    
                    if (zombieInRange && currentTime - this.lastShot > PLANTS_DB.peashooter.shootCooldown) {
                        this.shoot();
                        this.lastShot = currentTime;
                    }
                }
            }

            shoot() {
                bullets.push(new Bullet(this.x + this.width/2, this.y, -1)); // -1 æ˜¯å‘å·¦å°„å‡»
            }
            
            takeDamage() {
                // åšæœå¢™æœ‰è¡€é‡
                if (this.type === 'wallnut' && this.health > 1) {
                    this.health--;
                    return true;
                }
                return false;
            }
        }

        class Zombie {
            constructor() {
                this.x = canvas.width; // ä»å³ä¾§å‡ºç°
                this.width = 40;
                this.height = 60;
                this.speed = 0.5;
                this.color = '#e74c3c';
                this.health = 3;
                this.isDead = false;
                
                // éšæœºåˆ†é…ä¸€è¡Œ
                const randomRow = Math.floor(Math.random() * ROWS);
                this.y = randomRow * GRID_SIZE + 50;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // ç®€å•çš„çœ¼ç›
                ctx.fillStyle = 'white';
                ctx.fillRect(this.x + 5, this.y + 10, 10, 10);
                ctx.fillRect(this.x + 25, this.y + 10, 10, 10);
                ctx.fillStyle = 'black';
                ctx.fillRect(this.x + 8, this.y + 14, 4, 4);
                ctx.fillRect(this.x + 30, this.y + 14, 4, 4);
                
                // å—ä¼¤æ•ˆæœ
                if (this.health < 3) {
                    ctx.fillStyle = 'yellow';
                    ctx.fillText('!', this.x + 10, this.y + 35);
                }
            }

            update() {
                this.x -= this.speed;
                
                // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾å·¦è¾¹
                if (this.x < 0) {
                    this.isDead = true;
                    return false; // å¤±è´¥
                }
                return true;
            }
        }

        class Bullet {
            constructor(x, y, dir) {
                this.x = x;
                this.y = y;
                this.vx = 5 * dir; // é€Ÿåº¦
                this.radius = 5;
                this.isDead = false;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
            }

            update() {
                this.x += this.vx;

                // è¾¹ç•Œæ£€æŸ¥
                if (this.x < 0 || this.x > canvas.width) {
                    this.isDead = true;
                }

                // ç¢°æ’æ£€æµ‹ (å­å¼¹ vs åƒµå°¸)
                for (let z of zombies) {
                    if (!z.isDead && 
                        this.x > z.x && this.x < z.x + z.width &&
                        this.y > z.y && this.y < z.y + z.height) {
                        
                        z.health--;
                        this.isDead = true; // å­å¼¹æ¶ˆå¤±
                        
                        if (z.health <= 0) {
                            z.isDead = true;
                            // æ€æ­»åƒµå°¸å¥–åŠ±é˜³å…‰
                            sun += 25;
                        }
                        break;
                    }
                }
            }
        }

        // --- æ¸¸æˆæ§åˆ¶å‡½æ•° ---

        function selectPlant(type) {
            selectedPlantType = type;
            
            // æ›´æ–°UIæŒ‰é’®æ ·å¼
            document.querySelectorAll('.btn-sunflower, .btn-peashooter, .btn-wallnut').forEach(b => b.classList.remove('selected'));
            document.querySelector(`.btn-${type}`).classList.add('selected');
        }

        function resetGame() {
            score = 50;
            sun = 0;
            plants = [];
            zombies = [];
            bullets = [];
            lastTime = 0;
            updateUI();
        }

        function updateUI() {
            scoreEl.innerText = score;
            sunEl.innerText = sun;
            zombieCountEl.innerText = zombies.length;
        }

        function drawBackground() {
            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#5d6d7e';
            ctx.lineWidth = 1;
            
            // åœ°é¢çº¿æ¡
            for (let i = 0; i <= ROWS; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * GRID_SIZE + 50);
                ctx.lineTo(canvas.width, i * GRID_SIZE + 50);
                ctx.stroke();
            }
            for (let i = 0; i <= COLS; i++) {
                ctx.beginPath();
                ctx.moveTo(i * GRID_SIZE, 0); // èƒŒæ™¯å¯ä»¥ç”»æ»¡é«˜åº¦
                ctx.lineTo(i * GRID_SIZE, canvas.height);
                ctx.stroke();
            }

            // ç»˜åˆ¶åœ°é¢è‰åœ°
            ctx.fillStyle = '#76d36e';
            ctx.fillRect(0, (ROWS) * GRID_SIZE + 50, canvas.width, canvas.height - ((ROWS) * GRID_SIZE + 50));
        }
        
        function drawSunEffect(x, y) {
            ctx.beginPath();
            ctx.fillStyle = `rgba(241, 196, 15, ${Math.random()})`;
            ctx.arc(x, y, 20, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = 'orange';
            ctx.stroke();
        }

        // --- æ ¸å¿ƒå¾ªç¯ ---

        function loop(timestamp) {
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;

            // 1. æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 2. ç»˜åˆ¶èƒŒæ™¯
            drawBackground();

            // 3. é˜³å…‰è‡ªåŠ¨æ¢å¤ (æ²¡æœ‰é˜³å…‰æœºåˆ¶ï¼Œåªæ˜¯åŸºç¡€ç©æ³•)
            sunProductionTimer += deltaTime;
            if (sunProductionTimer > 2000 && sun < 500) {
                sun++;
                sunProductionTimer = 0;
            }

            // 4. ç”Ÿæˆåƒµå°¸é€»è¾‘ - åªæœ‰å½“æœ‰é˜³å…‰æ—¶æ‰ä¼šç”Ÿæˆåƒµå°¸ï¼Œå¹¶ä¸”ç”Ÿæˆé¢‘ç‡åŠ é€Ÿ
            dropZombieTimer += deltaTime;
            let dropRate = Math.max(1000, 5000 - sun * 50); // é˜³å…‰è¶Šå¤šï¼Œåƒµå°¸è¶Šå¤š
            if (dropZombieTimer > dropRate && sun > 0) {
                zombies.push(new Zombie());
                dropZombieTimer = 0;
            }

            // 5. æ›´æ–°å’Œç»˜åˆ¶æ‰€æœ‰å®ä½“
            
            // æ¤ç‰©
            plants.forEach(p => {
                p.draw();
                p.update(timestamp);
            });

            // åƒµå°¸
            let gameOver = false;
            zombies = zombies.filter(z => !z.isDead);
            for (let z of zombies) {
                z.draw();
                if (!z.update()) {
                    gameOver = true;
                }
            }
            
            if (gameOver) {
                alert("æ¸¸æˆå¤±è´¥ï¼åƒµå°¸å…¥ä¾µäº†ä½ çš„è„‘å­ï¼");
                resetGame();
                return;
            }

            // å­å¼¹
            bullets = bullets.filter(b => !b.isDead);
            bullets.forEach(b => {
                b.draw();
                b.update();
            });

            updateUI();
            if (gameOver) return;
            gameLoopId = requestAnimationFrame(loop);
        }

        // --- é¼ æ ‡ç‚¹å‡»äº‹ä»¶ ---

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // è®¡ç®—ç‚¹å‡»äº†å“ªä¸ªæ ¼å­
            const col = Math.floor(x / GRID_SIZE);
            const row = Math.floor((y - 50) / GRID_SIZE); // å‡å»é¡¶éƒ¨åç§»

            // éªŒè¯ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨æ¸¸æˆåŒºåŸŸ
            if (col >= 0 && col < COLS && row >= 0 && row < ROWS) {
                
                // æ£€æŸ¥è¯¥æ ¼å­æ˜¯å¦å·²æœ‰æ¤ç‰©
                const existingPlant = plants.find(p => p.col === col && p.row === row);
                
                if (existingPlant) {
                    // å¦‚æœæ¤ç‰©æ­£åœ¨ç”Ÿé•¿ä¸­ï¼Œå¯ä»¥å–æ¶ˆ
                    if (!existingPlant.isGrown) {
                        plants = plants.filter(p => p !== existingPlant);
                        score += Math.floor(PLANTS_DB[existingPlant.type].cost * 0.5); // é€€å›50%é‡‘å¸
                        sun += Math.floor(PLANTS_DB[existingPlant.type].sunCost * 0.3); // é€€å›30%é˜³å…‰
                        updateUI();
                        return;
                    }
                    return; // å·²ç»æœ‰äº†æˆç†Ÿçš„æ¤ç‰©
                }
                
                // 1. å¦‚æœæœ‰é€‰ä¸­æ¤ç‰©ï¼Œå°è¯•ç§æ¤
                if (selectedPlantType) {
                    const cost = PLANTS_DB[selectedPlantType].cost;
                    const sunCost = PLANTS_DB[selectedPlantType].sunCost;
                    
                    // æ£€æŸ¥èµ„æºæ˜¯å¦è¶³å¤Ÿ
                    if (score >= cost && sun >= sunCost) {
                        score -= cost;
                        sun -= sunCost;
                        plants.push(new Plant(col, row, selectedPlantType));
                        updateUI();
                        
                        // å–æ¶ˆé€‰æ‹©
                        selectedPlantType = null;
                        document.querySelectorAll('.btn-sunflower, .btn-peashooter, .btn-wallnut').forEach(b => b.classList.remove('selected'));
                    } else {
                        // èµ„æºä¸è¶³æç¤º
                        const msg = [];
                        if (score < cost) msg.push(`é‡‘å¸ä¸è¶³ (+${cost})`);
                        if (sun < sunCost) msg.push(`é˜³å…‰ä¸è¶³ (+${sunCost})`);
                        alert('èµ„æºä¸è¶³:\n' + msg.join('\n'));
                    }
                }
            }
        });

        // --- å¯åŠ¨æ¸¸æˆ ---
        gameLoopId = requestAnimationFrame(loop);

    </script>
</body>
</html>
