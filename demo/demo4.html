      
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤å¤é»„é‡‘çŸ¿å·¥ (Retro Gold Miner)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');

        :root {
            --c-cyan: #00FFFF;
            --c-pink: #FF00FF;
            --c-yellow: #FFFF00;
            --c-black: #080808;
            --c-bg-dark: #220022;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--c-black);
            font-family: 'Bangers', 'Arial Black', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #gameContainer {
            position: relative;
            box-shadow: 15px 15px 0px var(--c-cyan);
            border: 5px solid var(--c-black);
        }

        canvas {
            background: conic-gradient(var(--c-bg-dark) 90deg, transparent 90deg);
            background-size: 50px 50px;
            /* åˆ›å»ºåŠè‰²è°ƒç½‘ç‚¹èƒŒæ™¯æ•ˆæœ */
            background-image:
                radial-gradient(var(--c-pink) 20%, transparent 20%),
                radial-gradient(var(--c-cyan) 20%, transparent 20%);
            background-color: var(--c-bg-dark);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
            display: block;
            cursor: crosshair;
        }

        /* é€šç”¨UIé£æ ¼ */
        .ui-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-2deg);
            background-color: var(--c-yellow);
            border: 8px solid var(--c-black);
            padding: 30px;
            text-align: center;
            box-shadow: 10px 10px 0 var(--c-pink);
            display: none; /* é»˜è®¤éšè— */
        }

        .ui-panel h1 {
            font-size: 4rem;
            color: var(--c-pink);
            text-shadow: 4px 4px var(--c-black);
            margin: 0 0 20px 0;
            -webkit-text-stroke: 2px var(--c-black);
        }

        .ui-panel p {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--c-black);
            margin: 10px 0;
        }

        button {
            font-family: 'Bangers', sans-serif;
            font-size: 1.5rem;
            padding: 10px 20px;
            margin: 10px;
            background-color: var(--c-cyan);
            border: 4px solid var(--c-black);
            box-shadow: 5px 5px 0 var(--c-black);
            cursor: pointer;
            transition: transform 0.1s;
        }

        button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 7px 7px 0 var(--c-black);
        }

        button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--c-black);
        }

        button:disabled {
            background-color: #999;
            cursor: not-allowed;
        }

        #shopItems {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .shop-item {
            background: white;
            border: 4px solid var(--c-black);
            padding: 15px;
            width: 120px;
        }

        .item-icon { font-size: 3rem; display: block; margin-bottom: 10px;}

    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="shopPanel" class="ui-panel">
        <h1>LEVEL COMPLETE!</h1>
        <p>ç›®æ ‡é‡‘é¢: $<span id="shopTarget"></span></p>
        <p>ä½ çš„ç°é‡‘: $<span id="shopCash"></span></p>
        <p style="color: var(--c-pink); font-size: 1.2rem;">(åªèƒ½èŠ±è´¹è¶…å‡ºç›®æ ‡çš„ç°é‡‘: $<span id="spendableCash"></span>)</p>

        <div id="shopItems">
            <div class="shop-item">
                <span class="item-icon">ğŸ§¨</span>
                <div>ç‚¸è¯</div>
                <div>$200</div>
                <button onclick="buyItem('dynamite', 200)">è´­ä¹°</button>
            </div>
            <div class="shop-item">
                <span class="item-icon">ğŸ’ª</span>
                <div>åŠ›é‡è¯æ°´</div>
                <div>$450</div>
                <button onclick="buyItem('strength', 450)">è´­ä¹°</button>
            </div>
            <div class="shop-item">
                <span class="item-icon">ğŸ€</span>
                <div>å¹¸è¿è‰</div>
                <div>$300</div>
                <button onclick="buyItem('clover', 300)">è´­ä¹°</button>
            </div>
        </div>
        <br>
        <button onclick="nextLevel()" style="font-size: 2rem; background-color: var(--c-pink); color: var(--c-yellow);">å¼€å§‹ä¸‹ä¸€å…³ NEXT LEVEL >></button>
    </div>

    <div id="gameOverPanel" class="ui-panel">
        <h1>GAME OVER</h1>
        <p>ä½ æ²¡æœ‰è¾¾åˆ°ç›®æ ‡é‡‘é¢ã€‚</p>
        <p>æœ€ç»ˆå¾—åˆ†: $<span id="finalScore"></span></p>
        <button onclick="restartGame()" style="font-size: 2rem;">é‡æ–°å¼€å§‹ RESTART</button>
    </div>
</div>

<script>
// --- é…ç½®ä¸å¸¸é‡ ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const C = {
    CYAN: '#00FFFF', PINK: '#FF00FF', YELLOW: '#FFFF00', BLACK: '#080808', WHITE: '#FFFFFF',
    GREY: '#777777', ROCK_COLOR: '#969696', GOLD_COLOR: '#FFD700',
    FONT: "bold 24px 'Bangers', sans-serif"
};

// æ¸¸æˆçŠ¶æ€
let gameState = 'START'; // START, PLAYING, SHOP, GAMEOVER
let level = 1;
let score = 0;
let targetScore = 0;
let timeRemaining = 0;
let gameLoopId;
let timerId;

// ç©å®¶é“å…·åº“å­˜/çŠ¶æ€
let inventory = { dynamite: 0 };
let activePowerups = { strength: false, clover: false };

// é’©çˆªç›¸å…³
const minerX = canvas.width / 2;
const minerY = 60;
let claw = {
    x: minerX, y: minerY,
    angle: Math.PI / 2, // åˆå§‹å‘ä¸‹
    angleSpeed: 0.03,
    angleDir: 1,
    length: 50,
    minLength: 50,
    maxLength: canvas.height + 100,
    state: 'swinging', // swinging, launching, retracting
    launchSpeed: 12,
    baseRetractSpeed: 12,
    heldItem: null
};

// åœ°ä¸‹ç‰©å“
let items = [];
let explosions = []; // å­˜å‚¨çˆ†ç‚¸åŠ¨ç”»æ•ˆæœ

// --- ç±»å®šä¹‰ ---
class Item {
    constructor(x, y, type) {
        this.x = x; this.y = y; this.type = type;
        this.a = 0; // éšæœºè§’åº¦ï¼Œç”¨äºç»˜åˆ¶
        this.initTypeStats();
    }
    initTypeStats() {
        switch (this.type) {
            case 'gold_s': this.r = 15; this.val = 50; this.weight = 1.5; break;
            case 'gold_m': this.r = 25; this.val = 150; this.weight = 3; break;
            case 'gold_l': this.r = 40; this.val = 500; this.weight = 6; break;
            case 'rock_s': this.r = 20; this.val = 15; this.weight = 5; break;
            case 'rock_l': this.r = 45; this.val = 35; this.weight = 10; break;
            case 'diamond': this.r = 12; this.val = 750; this.weight = 1; break;
            case 'bag': this.r = 20; this.val = '?'; this.weight = 2; break;
            case 'tnt': this.r = 18; this.val = 0; this.weight = 1; break;
        }
    }
    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.a);
        ctx.lineWidth = 4;
        ctx.strokeStyle = C.BLACK;

        if (this.type.includes('gold')) {
            ctx.fillStyle = C.GOLD_COLOR;
            ctx.beginPath(); ctx.arc(0, 0, this.r, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            // é—ªå…‰æ•ˆæœ
            ctx.fillStyle = C.WHITE; ctx.beginPath(); ctx.arc(-this.r/3, -this.r/3, this.r/4, 0, Math.PI*2); ctx.fill();
        } else if (this.type.includes('rock')) {
            ctx.fillStyle = C.ROCK_COLOR;
            // ç”»ä¸€ä¸ªä¸è§„åˆ™çš„å¤šè¾¹å½¢
            ctx.beginPath();
            ctx.moveTo(-this.r, -this.r/2); ctx.lineTo(0, -this.r); ctx.lineTo(this.r, -this.r/2);
            ctx.lineTo(this.r, this.r/2); ctx.lineTo(0, this.r); ctx.lineTo(-this.r, this.r/2);
            ctx.closePath(); ctx.fill(); ctx.stroke();
        } else if (this.type === 'diamond') {
            ctx.fillStyle = C.CYAN;
            ctx.beginPath(); ctx.moveTo(0, -this.r); ctx.lineTo(this.r, 0); ctx.lineTo(0, this.r); ctx.lineTo(-this.r, 0); ctx.closePath();
            ctx.fill(); ctx.stroke();
             // é—ªå…‰æ•ˆæœ
             ctx.fillStyle = C.WHITE; ctx.beginPath(); ctx.moveTo(0, -this.r/2); ctx.lineTo(this.r/2, 0); ctx.lineTo(0, this.r/2); ctx.lineTo(-this.r/2, 0); ctx.closePath(); ctx.fill();
        } else if (this.type === 'bag') {
            ctx.fillStyle = C.PINK;
            ctx.beginPath(); ctx.arc(0, 2, this.r, 0, Math.PI, false); // Bottom
            ctx.lineTo(-this.r+5, -this.r+5); ctx.lineTo(this.r-5, -this.r+5); ctx.closePath();
            ctx.fill(); ctx.stroke();
            ctx.fillStyle = C.YELLOW; ctx.fillText('?', -5, 5);
        } else if (this.type === 'tnt') {
            ctx.fillStyle = 'red';
            ctx.fillRect(-this.r+5, -this.r, this.r*2-10, this.r*2); ctx.strokeRect(-this.r+5, -this.r, this.r*2-10, this.r*2);
            ctx.fillStyle = C.YELLOW; ctx.fillText('TNT', -14, 5);
            // å¼•çº¿
            ctx.beginPath(); ctx.moveTo(0, -this.r); ctx.lineTo(5, -this.r-10); ctx.stroke();
        }
        ctx.restore();
    }
}

class Explosion {
    constructor(x, y) {
        this.x = x; this.y = y;
        this.r = 10;
        this.maxR = 120;
        this.opacity = 1;
    }
    update() {
        this.r += 10;
        this.opacity -= 0.05;
    }
    draw() {
        if (this.opacity <= 0) return;
        ctx.save();
        ctx.globalAlpha = this.opacity;
        ctx.fillStyle = C.YELLOW;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = C.PINK; ctx.lineWidth = 5; ctx.stroke();
        ctx.restore();
    }
}

// --- æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ---

function initLevel(lvl) {
    level = lvl;
    targetScore = score + level * 1200 + 500; // ç›®æ ‡éš¾åº¦æ›²çº¿
    timeRemaining = 60;
    items = [];
    claw.state = 'swinging';
    claw.length = claw.minLength;
    claw.heldItem = null;
    explosions = [];

    // ç®€å•çš„å…³å¡ç”Ÿæˆé€»è¾‘ (è¶Šå¾€åå¥½ä¸œè¥¿è¶Šå°‘ï¼ŒçŸ³å¤´è¶Šå¤š)
    let goldCount = Math.max(3, 10 - lvl);
    let rockCount = 5 + lvl * 2;
    let diamondCount = lvl >= 3 ? Math.floor(lvl/2) : (Math.random() > 0.7 ? 1 : 0);
    let tntCount = lvl >= 2 ? Math.floor(lvl/3) + 1 : 0;
    let bagCount = 2;

    generateItems('gold_l', Math.floor(goldCount/3));
    generateItems('gold_m', Math.floor(goldCount/3));
    generateItems('gold_s', goldCount - Math.floor(goldCount/3)*2);
    generateItems('rock_l', Math.floor(rockCount/2));
    generateItems('rock_s', rockCount - Math.floor(rockCount/2));
    generateItems('diamond', diamondCount);
    generateItems('tnt', tntCount);
    generateItems('bag', bagCount);

    document.getElementById('shopPanel').style.display = 'none';
    document.getElementById('gameOverPanel').style.display = 'none';
    gameState = 'PLAYING';

    clearInterval(timerId);
    timerId = setInterval(() => {
        if (gameState === 'PLAYING') {
            timeRemaining--;
            if (timeRemaining <= 0) checkLevelEnd();
        }
    }, 1000);
}

function generateItems(type, count) {
    for (let i = 0; i < count; i++) {
        let x = Math.random() * (canvas.width - 100) + 50;
        let y = Math.random() * (canvas.height - 250) + 200;
        items.push(new Item(x, y, type));
    }
}

function update() {
    if (gameState !== 'PLAYING') return;

    // 1. æ›´æ–°é’©çˆªçŠ¶æ€
    if (claw.state === 'swinging') {
        claw.angle += claw.angleSpeed * claw.angleDir;
        if (claw.angle > Math.PI - 0.2 || claw.angle < 0.2) claw.angleDir *= -1;
        claw.x = minerX + Math.cos(claw.angle) * claw.length;
        claw.y = minerY + Math.sin(claw.angle) * claw.length;
    }
    else if (claw.state === 'launching') {
        claw.length += claw.launchSpeed;
        claw.x = minerX + Math.cos(claw.angle) * claw.length;
        claw.y = minerY + Math.sin(claw.angle) * claw.length;

        // è¾¹ç•Œç¢°æ’æˆ–æœ€å¤§é•¿åº¦
        if (claw.length >= claw.maxLength || claw.x < 0 || claw.x > canvas.width || claw.y > canvas.height) {
            claw.state = 'retracting';
        }
        // ç‰©å“ç¢°æ’æ£€æµ‹
        for (let i = items.length - 1; i >= 0; i--) {
            let item = items[i];
            let dx = claw.x - item.x;
            let dy = claw.y - item.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < item.r + 5) {
                // æŠ“åˆ°äº†!
                if (item.type === 'tnt') {
                    triggerExplosion(item.x, item.y);
                    items.splice(i, 1);
                    claw.state = 'retracting';
                    claw.launchSpeed = 20; // çˆ†ç‚¸åå¿«é€Ÿæ”¶å›
                } else {
                    claw.heldItem = item;
                    claw.state = 'retracting';
                    items.splice(i, 1);
                }
                break;
            }
        }
    }
    else if (claw.state === 'retracting') {
        let speed = claw.baseRetractSpeed;
        if (claw.heldItem) {
            let weightFactor = claw.heldItem.weight;
            if (activePowerups.strength) weightFactor = Math.max(1, weightFactor / 3); // åŠ›é‡è¯æ°´æ•ˆæœ
            speed = speed / weightFactor;
        }
        claw.length -= speed;
        if (claw.length <= claw.minLength) {
            claw.length = claw.minLength;
            claw.state = 'swinging';
            claw.launchSpeed = 12; // é‡ç½®é€Ÿåº¦ï¼ˆä»¥é˜²TNTåŠ é€Ÿï¼‰
            if (claw.heldItem) collectItem(claw.heldItem);
            claw.heldItem = null;
        }
        claw.x = minerX + Math.cos(claw.angle) * claw.length;
        claw.y = minerY + Math.sin(claw.angle) * claw.length;
        if (claw.heldItem) {
            claw.heldItem.x = claw.x; claw.heldItem.y = claw.y;
        }
    }

    // 2. æ›´æ–°çˆ†ç‚¸æ•ˆæœ
    explosions.forEach(exp => exp.update());
    explosions = explosions.filter(exp => exp.opacity > 0);
}

function triggerExplosion(x, y) {
    explosions.push(new Explosion(x, y));
    let blastRadius = 150;
    for (let i = items.length - 1; i >= 0; i--) {
        let item = items[i];
        let dx = x - item.x;
        let dy = y - item.y;
        if (Math.sqrt(dx*dx + dy*dy) < blastRadius) {
            if (item.type === 'tnt') triggerExplosion(item.x, item.y); // è¿é”çˆ†ç‚¸
            items.splice(i, 1);
        }
    }
}

function collectItem(item) {
    let value = item.val;
    if (item.type === 'bag') {
        // ç¦è¢‹é€»è¾‘
        let roll = Math.random();
        if (activePowerups.clover) roll += 0.2; // å¹¸è¿è‰æ•ˆæœ

        if (roll > 0.85) { value = 800; showFloatingText("$800!", claw.x, claw.y); }
        else if (roll > 0.6) { value = 'strength'; showFloatingText("åŠ›é‡æå‡!", claw.x, claw.y); }
        else if (roll > 0.4) { value = 200; showFloatingText("$200", claw.x, claw.y); }
        else { value = 50; showFloatingText("$50...", claw.x, claw.y); }
    }

    if (value === 'strength') {
        // ç«‹å³ç”Ÿæ•ˆï¼Œæˆ–è€…å­˜åˆ°ä¸‹ä¸€ä¸ªå…³å¡? ç»å…¸ç‰ˆçŸ¿å·¥é€šå¸¸æ˜¯å­˜åˆ°ä¸‹ä¸€å…³æˆ–å½“å‰å…³ç«‹å³ç”Ÿæ•ˆã€‚è¿™é‡Œç®€åŒ–ä¸ºå­˜ä¸ªæ ‡è®°ç»™ä¸‹ä¸€å…³å•†åº—ç”¨
        // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬è®©å®ƒç«‹å³ç”Ÿæ•ˆå¹¶æ˜¾ç¤ºåœ¨UIä¸Šï¼Œä½†å•†åº—è´­ä¹°çš„æ˜¯"æå‡ä¸‹ä¸€å…³"
        // è¿™é‡Œä¸ºäº†ç¬¦åˆä½ çš„"åŠ›é‡è¯æ°´"è®¾å®š(æå‡ä¸‹ä¸€å…³)ï¼Œæˆ‘ä»¬æŠŠå•†åº—ä¹°çš„æ ‡è®°ä¸º next_strength
        // è¿™é‡Œçš„ç¦è¢‹ç›´æ¥ç»™å½“å‰èƒ½åŠ›
        activePowerups.strength = true;
        setTimeout(() => activePowerups.strength = false, 5000); // æŒç»­5ç§’æç¤ºæˆ–è€…ä»…æœ¬é’©çˆªæœ‰æ•ˆ?
        // ç»å…¸ç‰ˆé€šå¸¸æ˜¯æŒç»­ä¸€é’©çš„ã€‚æˆ‘ä»¬ç®€åŒ–ï¼šç¦è¢‹è·å¾—ä¸´æ—¶åŠ›é‡
        // ä¸ºäº†ç¬¦åˆ"æå‡ä¸‹ä¸€å…³"çš„å•†åº—é€»è¾‘ï¼Œç¦è¢‹åº”è¯¥ç®—ä½œ"æŠ½åˆ°äº†åŠ›é‡"ã€‚
        // è®©æˆ‘ä»¬ç®€åŒ–ï¼šç¦è¢‹å¦‚æœæ˜¯åŠ›é‡ï¼Œç›´æ¥åŠ åˆ°å½“å‰å…³å¡å‰©ä½™æ—¶é—´å†…
        activePowerups.strength = true;
        // æ¢å¤åŸçŠ¶ä»£ç åœ¨checkLevelEndæˆ–è€…ä¸‹ä¸€é’©å¼€å§‹å‰å¾ˆéš¾åˆ¤æ–­ã€‚
        // è®©æˆ‘ä»¬ä¿®æ”¹é€»è¾‘ï¼šç¦è¢‹å¦‚æœæ˜¯åŠ›é‡ï¼Œç»™inventoryåŠ ä¸€ä¸ªæœ¬å…³å¯ç”¨çš„æ ‡è®°
    } else {
        score += value;
    }
}

function useDynamite() {
    if (claw.state === 'retracting' && claw.heldItem && inventory.dynamite > 0) {
        inventory.dynamite--;
        triggerExplosion(claw.x, claw.y);
        claw.heldItem = null;
        // ç‚¸è¯ç‚¸å®Œç›´æ¥ç©ºæ‰‹æ”¶å›ï¼Œä¸éœ€è¦ç‰¹æ®Šå¤„ç†çŠ¶æ€ï¼Œä¸‹ä¸€å¸§retractingç»§ç»­
    }
}

// --- æ¸²æŸ“ ---
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 1. ç»˜åˆ¶UIä¿¡æ¯æ  (é¡¶éƒ¨)
    drawUIBar();

    // 2. ç»˜åˆ¶çŸ¿å·¥ (ç®€åŒ–ä¸ºä¸€ä¸ªæ–¹å—å’Œå¤´éƒ¨)
    drawMiner();

    // 3. ç»˜åˆ¶é’©çˆªè¿æ¥çº¿
    ctx.beginPath();
    ctx.moveTo(minerX, minerY);
    ctx.lineTo(claw.x, claw.y);
    ctx.strokeStyle = C.BLACK;
    ctx.lineWidth = 3;
    ctx.stroke();

    // 4. ç»˜åˆ¶ç‰©å“ (åœ¨åœ°ä¸‹çš„)
    items.forEach(item => item.draw());

    // 5. ç»˜åˆ¶è¢«æŠ“å–çš„ç‰©å“
    if (claw.heldItem) claw.heldItem.draw();

    // 6. ç»˜åˆ¶é’©çˆªå¤´
    drawClawHead();

    // 7. ç»˜åˆ¶çˆ†ç‚¸
    explosions.forEach(exp => exp.draw());

}

function drawUIBar() {
    ctx.fillStyle = C.YELLOW;
    ctx.fillRect(0, 0, canvas.width, 50);
    ctx.strokeStyle = C.BLACK;
    ctx.lineWidth = 4;
    ctx.beginPath(); ctx.moveTo(0, 50); ctx.lineTo(canvas.width, 50); ctx.stroke();

    ctx.fillStyle = C.BLACK;
    ctx.font = C.FONT;
    ctx.fillText(`ğŸ’° é‡‘é’±: $${score}`, 20, 32);
    ctx.fillText(`ğŸ¯ ç›®æ ‡: $${targetScore}`, 250, 32);
    ctx.fillText(`â° æ—¶é—´: ${timeRemaining}`, 500, 32);
    ctx.fillText(`LEVEL: ${level}`, 650, 32);

    // ç»˜åˆ¶é“å…·æ 
    if (inventory.dynamite > 0) {
         ctx.fillStyle = 'red'; ctx.fillText(`ğŸ§¨ x${inventory.dynamite}`, 730, 32);
         ctx.strokeStyle = C.BLACK; ctx.strokeText(`ğŸ§¨ x${inventory.dynamite}`, 730, 32);
    }
    // ç»˜åˆ¶æ¿€æ´»çŠ¶æ€
    if(activePowerups.strength) ctx.fillText('ğŸ’ª', 620, 32);
    if(activePowerups.clover) ctx.fillText('ğŸ€', 590, 32);

    // ç»˜åˆ¶UIæè¾¹
    ctx.strokeStyle = C.CYAN;
    ctx.lineWidth = 1;
    ctx.strokeText(`ğŸ’° é‡‘é’±: $${score}`, 20, 32);
    ctx.strokeText(`ğŸ¯ ç›®æ ‡: $${targetScore}`, 250, 32);
    ctx.strokeText(`â° æ—¶é—´: ${timeRemaining}`, 500, 32);

    // æ–œçº¿è£…é¥°
    ctx.save();
    ctx.translate(400, 25);
    ctx.rotate(-0.1);
    ctx.beginPath();
    ctx.moveTo(-200, 0); ctx.lineTo(200, 0);
    ctx.stroke();
    ctx.restore();
}

function drawMiner() {
    // ç¡¬é˜´å½±
    ctx.fillStyle = C.BLACK;
    ctx.fillRect(minerX - 20, minerY - 40, 45, 50);
    // èº«ä½“
    ctx.fillStyle = C.CYAN;
    ctx.strokeStyle = C.BLACK;
    ctx.lineWidth = 3;
    ctx.fillRect(minerX - 15, minerY - 35, 35, 40);
    ctx.strokeRect(minerX - 15, minerY - 35, 35, 40);
    // å¤´
    ctx.fillStyle = C.YELLOW;
    ctx.strokeStyle = C.BLACK;
    ctx.beginPath();
    ctx.arc(minerX, minerY - 50, 18, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();
    // å·è½´æœº
    ctx.fillStyle = C.GREY;
    ctx.fillRect(minerX - 25, minerY - 10, 55, 20);
    ctx.strokeRect(minerX - 25, minerY - 10, 55, 20);
}

function drawClawHead() {
    ctx.save();
    ctx.translate(claw.x, claw.y);
    ctx.rotate(claw.angle + Math.PI/2);
    ctx.fillStyle = C.GREY;
    ctx.strokeStyle = C.BLACK;
    ctx.lineWidth = 3;
    // ç”»ä¸€ä¸ªç®€å•çš„é’³å­å½¢çŠ¶
    ctx.beginPath();
    ctx.moveTo(-10, 0); ctx.lineTo(-15, 15); ctx.lineTo(-5, 20); ctx.lineTo(0, 5);
    ctx.lineTo(5, 20); ctx.lineTo(15, 15); ctx.lineTo(10, 0);
    ctx.closePath();
    ctx.fill(); ctx.stroke();
    ctx.restore();
}

// --- æ¸¸æˆæµç¨‹æ§åˆ¶ ---

function checkLevelEnd() {
    gameState = 'FINISHED';
    clearInterval(timerId);
    if (score >= targetScore) {
        // è¿‡å…³ï¼Œè¿›å…¥å•†åº—
        gameState = 'SHOP';
        showShop();
    } else {
        // å¤±è´¥
        gameState = 'GAMEOVER';
        document.getElementById('finalScore').innerText = score;
        document.getElementById('gameOverPanel').style.display = 'block';
    }
}

function showShop() {
    const spendable = Math.max(0, score - targetScore);
    document.getElementById('shopTarget').innerText = targetScore;
    document.getElementById('shopCash').innerText = score;
    document.getElementById('spendableCash').innerText = spendable;

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    const btns = document.querySelectorAll('.shop-item button');
    btns[0].disabled = spendable < 200;
    btns[1].disabled = spendable < 450;
    btns[2].disabled = spendable < 300;

    document.getElementById('shopPanel').style.display = 'block';
}

function buyItem(item, price) {
    const spendable = Math.max(0, score - targetScore);
    if (spendable >= price) {
        score -= price;
        if (item === 'dynamite') inventory.dynamite++;
        if (item === 'strength') activePowerups.strength = true;
        if (item === 'clover') activePowerups.clover = true;
        showShop(); // æ›´æ–°ç•Œé¢æ˜¾ç¤º
    }
}

function nextLevel() {
    initLevel(level + 1);
}

function restartGame() {
    score = 0;
    level = 1;
    inventory = { dynamite: 0 };
    activePowerups = { strength: false, clover: false };
    initLevel(1);
}

// ç®€å•çš„æµ®åŠ¨æ–‡å­—æ•ˆæœï¼ˆç®€åŒ–ç‰ˆï¼Œç›´æ¥ç”»åœ¨canvasä¸Šè¢«è¦†ç›–ï¼Œè¿™é‡Œç•¥è¿‡å¤æ‚åŠ¨ç”»ï¼Œä»…ç”¨consoleæˆ–ç®€å•çš„DOMæç¤ºä»£æ›¿ï¼‰
function showFloatingText(text, x, y) {
    // åœ¨è¿™é‡Œä¸ºäº†ä»£ç ç®€æ´ï¼Œæˆ‘ä»¬åªåœ¨æ§åˆ¶å°æˆ–è€…é€šè¿‡UIé—ªçƒæ¥åé¦ˆ
    console.log(text);
}

// --- è¾“å…¥æ§åˆ¶ ---
function handleInput(e) {
    if (gameState !== 'PLAYING') return;
    e.preventDefault();

    // å‘å°„é’©çˆª (é¼ æ ‡ç‚¹å‡» æˆ– ç©ºæ ¼é”®/ä¸‹æ–¹å‘é”®)
    if ((e.type === 'mousedown' || e.code === 'Space' || e.code === 'ArrowDown') && claw.state === 'swinging') {
        claw.state = 'launching';
    }
    // ä½¿ç”¨ç‚¸è¯ (ä¸Šæ–¹å‘é”® æˆ– 'D'é”®)
    if ((e.code === 'ArrowUp' || e.code === 'KeyD') && claw.state === 'retracting') {
        useDynamite();
    }
}

canvas.addEventListener('mousedown', handleInput);
document.addEventListener('keydown', handleInput);


// --- æ¸¸æˆä¸»å¾ªç¯ ---
function gameLoop() {
    update();
    draw();
    gameLoopId = requestAnimationFrame(gameLoop);
}

// å¼€å§‹æ¸¸æˆ
restartGame();
gameLoop();

</script>
</body>
</html>

    